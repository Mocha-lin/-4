<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>bbb 投資戰情室 (Ultimate)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #F9F7F2; --accent: #8B7355; --text: #374151; --border: #E5E7EB; }
        /* 1. 全域字體加大 */
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; overflow: hidden; font-size: 16px; }
        
        .glass-panel { background: white; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-radius: 8px; }
        .header-title { font-size: 1.1rem; font-weight: 800; color: #4B5563; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; letter-spacing: 0.05em; }
        
        /* 表格字體加大 */
        .data-table th { @apply bg-gray-50 text-sm text-gray-500 uppercase font-bold p-3 text-right sticky top-0; }
        .data-table td { @apply p-3 text-base border-b border-gray-100 text-right font-mono outline-none transition duration-200; }
        .editable:hover { background-color: #FFFBF0; cursor: text; box-shadow: inset 0 0 0 1px #8B7355; }
        .editable:focus { background-color: #FFFFFF; box-shadow: inset 0 0 0 2px #8B7355; }

        .fact-row td { color: #111827; font-weight: 600; }
        .est-row td { color: #2563EB; font-weight: 700; font-style: italic; background-color: #F8FAFC; }
        .est-tag { font-size: 0.75rem; background: #2563EB; color: white; padding: 1px 4px; border-radius: 2px; margin-left: 4px; vertical-align: middle; }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 99; display: none; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(2px); }
    </style>
</head>
<body class="flex flex-col">

    <div id="processingOverlay" class="loading-overlay">
        <div class="text-[#8B7355] text-5xl mb-4"><i class="fas fa-satellite-dish fa-spin"></i></div>
        <h2 class="text-xl font-bold">呼叫 bbb 戰情室...</h2>
        <p class="text-gray-500 mt-2">AI 正在分析 <span id="targetStock" class="font-bold text-[#8B7355]"></span></p>
        <p class="text-xs text-gray-400 mt-4 animate-pulse">預計耗時 1-2 分鐘，請勿關閉視窗</p>
    </div>

    <div id="jsonModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white w-4/5 h-4/5 rounded-xl shadow-2xl flex flex-col p-6 animate-fade-in-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-[#8B7355]"><i class="fas fa-file-import mr-2"></i> 手動匯入 bbb 報告</h3>
                <button onclick="toggleModal('jsonModal')" class="text-3xl text-gray-400 hover:text-black">&times;</button>
            </div>
            <textarea id="jsonInput" class="flex-1 border-2 border-gray-200 p-4 font-mono text-sm rounded-lg focus:border-[#8B7355] outline-none transition" placeholder='請貼上 JSON...'></textarea>
            <div class="mt-4 text-right">
                <button onclick="importJSON()" class="px-6 py-2 bg-[#8B7355] text-white rounded-lg font-bold shadow hover:bg-[#6e5a40] transition">確認匯入</button>
            </div>
        </div>
    </div>

    <header class="bg-[#ECE8DE] h-14 flex items-center px-6 border-b border-[#DCD6C9] justify-between shrink-0 shadow-sm z-20">
        <div class="font-black text-xl tracking-widest text-[#5A4A42]">bbb ANALYTICS <span class="text-xs font-normal text-gray-500 ml-1">Ultimate</span></div>
        <div class="flex items-center gap-3">
            <div id="statusBadge" class="text-xs font-mono px-2 py-1 rounded bg-gray-200 text-gray-500 hidden md:flex">Offline</div>
            <button onclick="toggleModal('jsonModal')" class="bg-[#8B7355] text-white px-3 py-1.5 rounded-full text-xs font-bold shadow flex items-center gap-2 hover:scale-105 transition">
                <i class="fas fa-cloud-upload-alt"></i> 手動匯入
            </button>
            <button onclick="syncData(true)" class="bg-white border border-[#D1C7B7] text-[#8B7355] px-3 py-1.5 rounded text-xs font-bold hover:bg-gray-50 shadow-sm transition">
                <i class="fas fa-sync-alt mr-1"></i> 刷新雲端
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-[20%] min-w-[280px] bg-[#F5F2EB] border-r border-[#E5E0D8] flex flex-col z-10">
            <div class="p-3 border-b border-[#E5E0D8]">
                <div class="relative">
                    <input type="text" id="addStockInput" placeholder="代號 按 Enter" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-[#8B7355] font-mono">
                    <button onclick="triggerAddStock()" class="absolute right-2 top-2 text-[#8B7355]"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            <div id="stockList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-[#FDFBF7] p-8" id="mainBoard">
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-gray-300">
                <i class="fas fa-folder-open text-8xl mb-6 opacity-30"></i>
                <p class="text-xl">請選擇股票或匯入資料</p>
            </div>

            <div id="dashboard" class="hidden max-w-[1400px] mx-auto space-y-8 pb-24">
                
                <div class="flex flex-col md:flex-row justify-between items-end border-b-4 border-[#8B7355] pb-4">
                    <div>
                        <h1 class="text-6xl font-extrabold text-[#2C3E50] tracking-tighter mb-2" id="d_name_id">--</h1>
                        <div class="flex items-center gap-3 text-sm font-mono text-gray-500">
                            <span id="d_date">--</span>
                            <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded" id="aiModelTag">AI</span>
                            <span class="text-red-500 font-bold" id="d_note"></span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="d_price" class="text-7xl font-mono font-bold text-[#2C3E50] tracking-tighter">--</div>
                        <div id="d_change" class="text-2xl font-bold">--</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="col-span-2 glass-panel p-6">
                        <div class="header-title text-[#8B7355]"><span>產業護城河 (AI)</span></div>
                        <div class="text-lg text-gray-700 leading-8 mb-4" id="d_moat_desc">--</div>
                        <div class="flex gap-4 text-sm font-mono">
                            <div class="bg-gray-50 p-3 rounded flex-1"><strong>POSITION:</strong> <span id="d_pos">--</span></div>
                            <div class="bg-gray-50 p-3 rounded flex-1"><strong>RIVALS:</strong> <span id="d_comp">--</span></div>
                        </div>
                    </div>
                    <div class="col-span-1 glass-panel bg-[#FFFDF5] p-5">
                        <div class="header-title text-[#8B7355]"><span>備忘錄</span></div>
                        <textarea id="d_memo" class="w-full h-40 bg-transparent border-none text-base resize-none focus:ring-0" placeholder="點擊輸入..."></textarea>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass-panel p-6">
                        <div class="header-title text-[#8B7355]"><span>EPS (由左至右為時間軸)</span></div>
                        <div class="h-56 mb-4"><canvas id="chart_eps"></canvas></div>
                        <div class="overflow-x-auto"><table class="w-full data-table"><tbody id="t_eps"></tbody></table></div>
                    </div>
                    <div class="glass-panel p-6">
                        <div class="header-title text-[#8B7355]"><span>月營收動能 (由左至右)</span></div>
                        <div class="h-56 mb-4"><canvas id="chart_rev"></canvas></div>
                        <div class="overflow-x-auto"><table class="w-full data-table"><tbody id="t_rev"></tbody></table></div>
                    </div>
                </div>

                <div class="glass-panel p-6">
                    <div class="header-title text-[#8B7355]">PE 河流圖 (區間填充與數值)</div>
                    <div class="h-[500px] w-full"><canvas id="chart_river"></canvas></div>
                </div>

                <div class="glass-panel p-6 border-l-[8px] border-[#8B7355]">
                    <div class="header-title text-[#8B7355]"><span>技術預測</span><span id="d_c" class="text-sm">--</span></div>
                    <p class="text-lg text-gray-700 mb-6 leading-relaxed" id="d_tech_txt">--</p>
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div class="p-4 border rounded bg-white font-mono"><div class="text-xs text-gray-400">30D</div><div id="p_30" class="text-xl font-bold">--</div></div>
                        <div class="p-4 border rounded bg-white font-mono"><div class="text-xs text-gray-400">180D</div><div id="p_180" class="text-xl font-bold">--</div></div>
                        <div class="p-4 border rounded bg-white font-mono"><div class="text-xs text-gray-400">360D</div><div id="p_360" class="text-xl font-bold">--</div></div>
                        <div class="p-4 border border-[#8B7355] bg-[#FFFBF0] rounded font-mono"><div class="text-xs text-[#8B7355] font-bold">進場</div><div id="p_entry" class="text-2xl font-black text-[#C0392B]">--</div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 設定 Chart.js 全域字體大小
        Chart.defaults.font.size = 14;

        let db = [];
        let currentStockId = null;
        let chartInstances = { river: null, eps: null, rev: null };

        // 以下維持核心邏輯完全不動
        const GITHUB_TOKEN = "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";
        const GITHUB_USER = "Mocha-lin"; 
        const GITHUB_REPO = "-3";

        window.onload = () => {
            const localRaw = localStorage.getItem('bbb_db_v4');
            if(localRaw) db = JSON.parse(localRaw);
            renderSidebar();
            syncData();
        };

        async function syncData(force = false) {
            const badge = document.getElementById('statusBadge');
            badge.classList.remove('hidden');
            try {
                const url = force ? `./data.json?t=${Date.now()}` : './data.json';
                const res = await fetch(url);
                if(!res.ok) throw new Error("Offline");
                const cloudData = await res.json();
                if (Array.isArray(cloudData)) {
                    cloudData.forEach(cloudItem => {
                        const localIdx = db.findIndex(x => x.id === cloudItem.id);
                        if (localIdx !== -1) {
                            db[localIdx].basicInfo = cloudItem.basicInfo;
                            db[localIdx].lastUpdated = cloudItem.lastUpdated;
                        } else {
                            db.unshift(cloudItem);
                        }
                    });
                    saveToLocal();
                    renderSidebar();
                    if(currentStockId) loadStock(currentStockId);
                    badge.innerHTML = "Online";
                }
            } catch (e) { badge.innerHTML = "Local Mode"; }
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function importJSON() {
            try {
                const raw = document.getElementById('jsonInput').value;
                const newData = JSON.parse(raw);
                const idx = db.findIndex(x => x.id === newData.id);
                if (idx !== -1) db[idx] = newData; else db.unshift(newData);
                saveToLocal(); toggleModal('jsonModal'); renderSidebar(); loadStock(newData.id);
            } catch (e) { alert("JSON 格式有誤"); }
        }

        function renderSidebar() {
            const list = document.getElementById('stockList');
            list.innerHTML = "";
            db.forEach(s => {
                const el = document.createElement('div');
                const chg = parseFloat(s.basicInfo.change) || 0;
                const color = chg >= 0 ? "text-[#C0392B]" : "text-[#16A34A]";
                el.className = `p-3 rounded cursor-pointer border hover:bg-white transition flex justify-between items-center ${currentStockId === s.id ? 'bg-white shadow-md border-l-4 border-l-[#8B7355]' : 'border-transparent'}`;
                el.innerHTML = `<div class="font-bold font-mono">${s.id} ${s.name}</div><div class="font-mono ${color}">${s.basicInfo.changePercent}</div>`;
                el.onclick = () => loadStock(s.id);
                list.appendChild(el);
            });
        }

        function loadStock(id) {
            const s = db.find(x => x.id === id);
            if (!s) return;
            currentStockId = id;
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            renderSidebar();

            document.getElementById('d_name_id').innerHTML = `<span class="text-[#8B7355] mr-3">${s.id}</span>${s.name}`;
            setText('d_date', s.lastUpdated);
            setText('d_note', s.basicInfo.note);
            
            const p = document.getElementById('d_price');
            p.innerText = s.basicInfo.price;
            p.className = `text-7xl font-mono font-bold ${(parseFloat(s.basicInfo.change)>=0) ? "text-[#C0392B]" : "text-[#16A34A]"}`;
            setText('d_change', `${s.basicInfo.change} (${s.basicInfo.changePercent})`);

            document.getElementById('d_moat_desc').innerText = s.industry.moat_status + " | " + (s.industry.moat_desc||"");
            setText('d_pos', s.industry.position_map);
            setText('d_comp', s.industry.competitors);
            document.getElementById('d_memo').value = s.memo || "";
            document.getElementById('d_memo').oninput = function() { s.memo = this.value; saveToLocal(); };

            renderEditableTable('t_eps', s.financials.eps_table || [], ['period','gross_margin','net_margin','eps','cumulative']);
            renderEditableTable('t_rev', (s.financials.revenue_trend||[]).slice(0,12), ['month','revenue','mom','yoy']);

            setText('d_c', "C: "+s.technical.correction_c);
            document.getElementById('d_tech_txt').innerText = s.technical.analysis_text;
            setText('p_30', s.technical.predictions.days30);
            setText('p_180', s.technical.predictions.days180);
            setText('p_360', s.technical.predictions.days360);
            setText('p_entry', s.technical.predictions.entry_zone);

            renderCharts(s);
        }

        function renderEditableTable(domId, dataArray, keys) {
            const el = document.getElementById(domId);
            el.innerHTML = '';
            dataArray.forEach((row, rIndex) => {
                let tr = document.createElement('tr');
                tr.className = row.is_estimate ? "est-row" : "fact-row";
                keys.forEach((key, kIndex) => {
                    let td = document.createElement('td');
                    td.className = kIndex === 0 ? "text-left" : "text-right editable";
                    td.innerHTML = row[key] + (kIndex === 0 && row.is_estimate ? '<span class="est-tag">預</span>' : '');
                    if (kIndex !== 0) {
                        td.contentEditable = true;
                        td.onblur = function() { dataArray[rIndex][key] = this.innerText; saveToLocal(); };
                    }
                    tr.appendChild(td);
                });
                el.appendChild(tr);
            });
        }

        function renderCharts(s) {
            // 1. 河流圖 (修正色帶填充與備註)
            const ctxRiver = document.getElementById('chart_river').getContext('2d');
            if (chartInstances.river) chartInstances.river.destroy();
            const rd = s.financials.valuation.pe_river_data;
            if(rd) {
                chartInstances.river = new Chart(ctxRiver, {
                    type: 'line',
                    data: {
                        labels: rd.dates,
                        datasets: [
                            { label: 'Price', data: rd.price, borderColor:'#374151', borderWidth:3, pointRadius:0, fill:false, z:10 },
                            { label: 'PE20', data: rd.pe20, borderColor:'#DC2626', borderWidth:1, pointRadius:0, fill:false },
                            { label: 'PE16', data: rd.pe16, borderColor:'#F59E0B', borderWidth:1, pointRadius:0, fill:'-1', backgroundColor:'rgba(220,38,38,0.08)' },
                            { label: 'PE12', data: rd.pe12, borderColor:'#16A34A', borderWidth:1, pointRadius:0, fill:'-1', backgroundColor:'rgba(245,158,11,0.12)' }
                        ]
                    },
                    options: { 
                        responsive:true, maintainAspectRatio:false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: { ticks: { font: { size: 14 } } },
                            x: { ticks: { font: { size: 12 } } }
                        }
                    }
                });
            }

            // 2. EPS (時序由左至右：Reverse Array)
            const ctxEps = document.getElementById('chart_eps').getContext('2d');
            if(chartInstances.eps) chartInstances.eps.destroy();
            const eD = [...(s.financials.eps_table || [])].reverse(); // 複製並反轉
            chartInstances.eps = new Chart(ctxEps, {
                type: 'line',
                data: {
                    labels: eD.map(e=>e.period),
                    datasets: [{
                        label: 'EPS', data: eD.map(e=>parseFloat(e.eps)),
                        borderColor: '#2563EB', backgroundColor: 'rgba(37,99,235,0.1)', fill: true, tension: 0.3
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
            });

            // 3. 營收 (時序由左至右：Reverse Array)
            const ctxRev = document.getElementById('chart_rev').getContext('2d');
            if(chartInstances.rev) chartInstances.rev.destroy();
            const rD = [...(s.financials.revenue_trend||[])].slice(0,12).reverse(); // 複製並反轉
            chartInstances.rev = new Chart(ctxRev, {
                type: 'bar',
                data: {
                    labels: rD.map(r=>r.month),
                    datasets: [{ 
                        label: 'Revenue', data: rD.map(r=>parseFloat(r.revenue)), 
                        backgroundColor: rD.map(r=>r.is_estimate ? '#93C5FD' : '#D1D5DB'),
                        borderRadius: 4
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
            });
        }

        async function triggerAddStock() {
            const input = document.getElementById('addStockInput');
            const id = input.value.trim().toUpperCase();
            if(!id || GITHUB_TOKEN.includes("貼")) return;
            document.getElementById('processingOverlay').style.display = 'flex';
            document.getElementById('targetStock').innerText = id;
            try {
                await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/dispatches`, {
                    method: 'POST',
                    headers: {'Accept':'application/vnd.github.v3+json', 'Authorization': `Bearer ${GITHUB_TOKEN}`},
                    body: JSON.stringify({ event_type: 'add_stock_trigger', client_payload: { stock_id: id } })
                });
                setTimeout(()=> { document.getElementById('processingOverlay').style.display='none'; syncData(true); }, 30000);
            } catch(e) { document.getElementById('processingOverlay').style.display = 'none'; }
        }

        function saveToLocal() { localStorage.setItem('bbb_db_v4', JSON.stringify(db)); }
        function setText(i,t) { if(document.getElementById(i)) document.getElementById(i).innerText=t||'-'; }
    </script>
</body>
</html>
